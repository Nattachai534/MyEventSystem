<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .bg-overlay {
            background-image: url('https://images.unsplash.com/photo-1513151233558-d860c5398176?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .btn-pink { background-color: #f472b6; color: white; }
        .btn-pink:hover { background-color: #ec4899; }
        
        /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á */
        .slot-machine { animation: bounce 0.5s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-overlay min-h-screen flex flex-col items-center justify-center p-4 relative">
    
    <div class="absolute inset-0 bg-white/40 backdrop-blur-sm z-0"></div>

    <div class="relative z-10 bg-white/95 p-6 rounded-2xl shadow-2xl w-full max-w-md text-center border-4 border-pink-200 overflow-y-auto max-h-screen">
        
        <div class="mb-4">
            <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="Logo" class="h-20 mx-auto mb-2 drop-shadow-md">
            <h1 class="text-xl font-bold text-pink-600">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô</h1>
            <h2 class="text-sm font-semibold text-pink-500">‡∏™‡πà‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏õ‡∏µ‡πÄ‡∏Å‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2569</h2>
            <h4 class="text-xs font-bold text-gray-700">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏£‡∏≤‡∏ä‡∏ß‡∏¥‡∏ñ‡∏µ</h4>
        </div>

        <hr class="border-pink-200 mb-4">

        <div id="registerForm">
            <input type="text" id="fname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" class="w-full p-3 mb-3 border-2 border-pink-100 rounded-xl">
            <input type="text" id="lname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-3 mb-3 border-2 border-pink-100 rounded-xl">
            <input type="text" id="org" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full p-3 mb-6 border-2 border-pink-100 rounded-xl">
            <button onclick="registerUser()" class="w-full btn-pink py-3 rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>

        <div id="qrArea" class="hidden pb-10">
            <div class="flex flex-col items-center mb-6">
                <p class="text-green-600 font-bold mb-2">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                <div id="qrcode" class="p-2 bg-white border-2 border-pink-200 rounded-lg shadow-sm"></div>
                <p class="text-gray-500 text-xs mt-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ</p>
            </div>

            <div class="w-full grid grid-cols-3 gap-2 mb-6">
                <div class="bg-pink-50 p-2 rounded-lg border border-pink-200">
                    <div class="text-xs text-gray-500">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
                    <div id="qFood" class="text-xl font-bold text-pink-600">-</div>
                </div>
                <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                    <div class="text-xs text-gray-500">‡∏Ç‡∏ô‡∏°</div>
                    <div id="qSnack" class="text-xl font-bold text-yellow-600">-</div>
                </div>
                <div class="bg-blue-50 p-2 rounded-lg border border-blue-200">
                    <div class="text-xs text-gray-500">‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</div>
                    <div id="qDrink" class="text-xl font-bold text-blue-600">-</div>
                </div>
            </div>

            <hr class="border-pink-200 mb-6">

            <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-xl border-2 border-purple-200 relative overflow-hidden">
                <div class="absolute -top-4 -right-4 text-purple-200 opacity-50"><i class="fas fa-gift text-9xl"></i></div>
                
                <h3 class="text-lg font-bold text-purple-700 relative z-10"><i class="fas fa-star text-yellow-400"></i> ‡∏•‡∏∏‡πâ‡∏ô‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</h3>
                <p class="text-xs text-purple-600 mb-4 relative z-10">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</p>
                
                <div id="giftResultArea" class="space-y-2 relative z-10">
                    </div>

                <button id="btnDrawGift" onclick="drawGift()" class="w-full mt-4 bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95 relative z-10">
                    <i class="fas fa-dice"></i> ‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏¢!
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, runTransaction, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ---
        const MAX_GIFT_QUOTA = 1; // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ 2 ‡∏ä‡∏¥‡πâ‡∏ô
        const RANDOM_RANGE = 500; // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç 1 - 500
        // -------------------

        const firebaseConfig = {
            apiKey: "...", // ‡πÉ‡∏™‡πà Config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUserDocId = null;

        // ‡πÄ‡∏ä‡πá‡∏Ñ LocalStorage
        const savedId = localStorage.getItem("rajavithi_event_uid");
        if (savedId) {
            currentUserDocId = savedId;
            showQR(savedId);
        }

        window.registerUser = async function() {
            const fname = document.getElementById('fname').value;
            const lname = document.getElementById('lname').value;
            const org = document.getElementById('org').value;

            if (!fname || !lname) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            try {
                const docRef = await addDoc(collection(db, "users"), {
                    firstname: fname,
                    lastname: lname,
                    organization: org,
                    quota: { food: 3, snack: 2, drink: 1 },
                    giftNumbers: [], // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ
                    timestamp: new Date()
                });

                localStorage.setItem("rajavithi_event_uid", docRef.id);
                currentUserDocId = docRef.id;
                showQR(docRef.id);
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            }
        }

        function showQR(id) {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('qrArea').classList.remove('hidden');

            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: id, width: 150, height: 150, colorDark : "#d53f8c", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
            });

            // Realtime Update ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
            onSnapshot(doc(db, "users", id), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Update Quota
                    document.getElementById("qFood").innerText = data.quota.food;
                    document.getElementById("qSnack").innerText = data.quota.snack;
                    document.getElementById("qDrink").innerText = data.quota.drink;

                    // Update Gift UI
                    renderGiftUI(data.giftNumbers || []);
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç
        function renderGiftUI(giftNumbers) {
            const resultArea = document.getElementById('giftResultArea');
            const btn = document.getElementById('btnDrawGift');
            
            resultArea.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤

            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß
            giftNumbers.forEach((num, index) => {
                resultArea.innerHTML += `
                    <div class="bg-white p-3 rounded-lg border-2 border-purple-300 flex justify-between items-center shadow-sm">
                        <span class="text-purple-800 font-bold">‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà ${index + 1}</span>
                        <span class="text-2xl font-black text-purple-600 bg-purple-100 px-3 rounded-full">#${num}</span>
                    </div>
                `;
            });

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤
            if (giftNumbers.length >= MAX_GIFT_QUOTA) {
                btn.classList.add('hidden');
                resultArea.innerHTML += `<p class="text-center text-green-600 font-bold mt-2">üéâ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>`;
            } else {
                btn.classList.remove('hidden');
                btn.innerHTML = `<i class="fas fa-dice"></i> ‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà ${giftNumbers.length + 1}`;
            }
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç (Logic ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡∏ã‡πâ‡∏≥)
        window.drawGift = async function() {
            if(!currentUserDocId) return;
            const btn = document.getElementById('btnDrawGift');
            
            // Animation ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢...`;

            try {
                // ‡πÉ‡∏ä‡πâ Transaction ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ 100%
                await runTransaction(db, async (transaction) => {
                    // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Global (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
                    const globalRef = doc(db, "system", "gift_tracker");
                    let globalDoc = await transaction.get(globalRef);
                    
                    if (!globalDoc.exists()) {
                         // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
                         transaction.set(globalRef, { used_numbers: [] });
                         globalDoc = { data: () => ({ used_numbers: [] }) }; // Mock data
                         // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Transaction ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á Retry ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                    }

                    const usedNumbers = globalDoc.data().used_numbers || [];
                    
                    // 2. ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
                    let randomNum;
                    let attempts = 0;
                    let found = false;
                    
                    while (!found && attempts < 100) {
                        randomNum = Math.floor(Math.random() * RANDOM_RANGE) + 1;
                        if (!usedNumbers.includes(randomNum)) {
                            found = true;
                        }
                        attempts++;
                    }

                    if (!found) throw "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏Ç‡∏ß‡πà‡∏≤‡∏á!";

                    // 3. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤)
                    const userRef = doc(db, "users", currentUserDocId);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw "User not found";
                    
                    const currentGifts = userDoc.data().giftNumbers || [];
                    if (currentGifts.length >= MAX_GIFT_QUOTA) throw "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß";

                    // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    transaction.update(globalRef, { used_numbers: [...usedNumbers, randomNum] });
                    transaction.update(userRef, { giftNumbers: arrayUnion(randomNum) });
                });

                // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô onSnapshot)
                
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e);
                btn.disabled = false;
                btn.innerHTML = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
            }
        }
    </script>
</body>
</html>
