<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Control Center - ‡∏£‡∏û.‡∏£‡∏≤‡∏ä‡∏ß‡∏¥‡∏ñ‡∏µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #fdf2f8; }
        .tab-active { background-color: #db2777; color: white; }
        .tab-inactive { background-color: #fce7f3; color: #db2777; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="sticky top-0 z-50 bg-white shadow-md">
        <div class="p-3 text-center border-b border-pink-100">
            <h1 class="text-lg font-bold text-pink-700">Staff Control Center</h1>
        </div>
        <div class="flex text-sm font-bold">
            <button onclick="switchTab('scanner')" id="tab-scanner" class="flex-1 py-3 tab-active transition-colors">
                <i class="fas fa-qrcode mr-2"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô
            </button>
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-3 tab-inactive transition-colors relative">
                <i class="fas fa-list mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç
                <span id="pendingCountBadge" class="hidden absolute top-2 right-4 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span>
            </button>
        </div>
    </div>

    <div id="view-scanner" class="flex-1 flex flex-col items-center p-4">
        
        <div id="readerWrapper" class="relative w-full max-w-sm mb-4">
            <div id="reader" class="w-full bg-black rounded-xl overflow-hidden shadow-lg border-4 border-pink-300"></div>
            <p id="cameraStatus" class="text-center text-xs text-gray-500 mt-2 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...</p>
        </div>

        <div id="resultArea" class="hidden w-full max-w-sm bg-white rounded-xl shadow-xl p-5 border border-pink-200">
            <div class="flex justify-between items-start border-b pb-3 mb-3">
                <div>
                    <h2 id="userName" class="text-xl font-bold text-pink-600">...</h2>
                    <p id="userOrg" class="text-sm text-gray-500">...</p>
                </div>
                <button onclick="resetScanner()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4 bg-purple-50 p-3 rounded-lg border border-purple-200">
                <h3 class="text-sm font-bold text-purple-700 mb-2"><i class="fas fa-gift"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</h3>
                <div id="scanGiftList" class="space-y-2 text-sm">
                    </div>
            </div>

            <div class="grid grid-cols-3 gap-2 text-center">
                <div onclick="deductQuota('food')" class="bg-pink-100 p-2 rounded cursor-pointer active:scale-95 transition">
                    <div class="text-xs text-pink-800">‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
                    <div id="sFood" class="font-bold text-pink-600 text-lg">-</div>
                </div>
                <div onclick="deductQuota('snack')" class="bg-yellow-100 p-2 rounded cursor-pointer active:scale-95 transition">
                    <div class="text-xs text-yellow-800">‡∏Ç‡∏ô‡∏°</div>
                    <div id="sSnack" class="font-bold text-yellow-600 text-lg">-</div>
                </div>
                <div onclick="deductQuota('drink')" class="bg-blue-100 p-2 rounded cursor-pointer active:scale-95 transition">
                    <div class="text-xs text-blue-800">‡∏ô‡πâ‡∏≥</div>
                    <div id="sDrink" class="font-bold text-blue-600 text-lg">-</div>
                </div>
            </div>
            
            <button onclick="resetScanner()" class="w-full mt-5 bg-gray-600 text-white py-2 rounded-lg font-bold text-sm">‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
    </div>

    <div id="view-dashboard" class="hidden flex-1 p-4 max-w-2xl mx-auto w-full">
        
        <div class="mb-4">
            <input type="text" id="searchInput" onkeyup="filterDashboard()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô..." class="w-full p-3 rounded-lg border border-pink-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
        </div>

        <div class="flex justify-between items-end mb-2">
            <h2 class="font-bold text-gray-700">üéÅ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç</h2>
            <span class="text-xs text-gray-500">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Real-time)</span>
        </div>

        <div id="dashboardList" class="space-y-3 pb-20">
            <div class="text-center py-10 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl"></i><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, updateDoc, increment, onSnapshot, arrayUnion, collection, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- ‚ö†Ô∏è CONFIG FIREBASE (‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCk02NdpvJx8xQSb0W2rJjWbsqgTx49-Ak"",
            authDomain: "myeventsystem-227c5.firebaseapp.com",
            projectId: "myeventsystem-227c5",
            storageBucket: "myeventsystem-227c5.firebasestorage.app",
            messagingSenderId: "16530953106",
            appId: "1:16530953106:web:8c138d0e74b690b64e674b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global Variables
        let currentScanUserId = null;
        let html5QrCode;
        let unsubscribeScanUser = null;
        let dashboardData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Search

        // ================= TAB SWITCHING =================
        window.switchTab = function(tabName) {
            const scanView = document.getElementById('view-scanner');
            const dashView = document.getElementById('view-dashboard');
            const btnScan = document.getElementById('tab-scanner');
            const btnDash = document.getElementById('tab-dashboard');

            if (tabName === 'scanner') {
                scanView.classList.remove('hidden');
                dashView.classList.add('hidden');
                btnScan.className = "flex-1 py-3 tab-active transition-colors";
                btnDash.className = "flex-1 py-3 tab-inactive transition-colors relative";
                // Start Camera if not running
                if(!html5QrCode?.isScanning) startCamera();
            } else {
                scanView.classList.add('hidden');
                dashView.classList.remove('hidden');
                btnScan.className = "flex-1 py-3 tab-inactive transition-colors";
                btnDash.className = "flex-1 py-3 tab-active transition-colors relative";
                // Stop Camera to save battery
                if(html5QrCode?.isScanning) html5QrCode.stop();
            }
        }

        // ================= LOGIC 1: SCANNER =================
        function startCamera() {
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                .then(() => document.getElementById("cameraStatus").innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô")
                .catch(() => document.getElementById("cameraStatus").innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á");
        }
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏¢
        startCamera();

        function onScanSuccess(decodedText) {
            html5QrCode.stop();
            document.getElementById("readerWrapper").classList.add('hidden');
            document.getElementById('resultArea').classList.remove('hidden');
            
            currentScanUserId = decodedText;
            
            // Listen Realtime (User ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πÅ‡∏Å‡∏ô)
            if(unsubscribeScanUser) unsubscribeScanUser();
            unsubscribeScanUser = onSnapshot(doc(db, "users", currentScanUserId), (docSnap) => {
                if (docSnap.exists()) {
                    renderScanResult(docSnap.data());
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
                    resetScanner();
                }
            });
        }

        function renderScanResult(data) {
            document.getElementById('userName').innerText = data.firstname + " " + data.lastname;
            document.getElementById('userOrg').innerText = data.organization;
            document.getElementById('sFood').innerText = data.quota.food;
            document.getElementById('sSnack').innerText = data.quota.snack;
            document.getElementById('sDrink').innerText = data.quota.drink;

            // Render Gift List (‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô)
            const listDiv = document.getElementById('scanGiftList');
            listDiv.innerHTML = "";
            const gifts = data.giftNumbers || [];
            const claimed = data.giftsClaimed || [];

            if (gifts.length === 0) {
                listDiv.innerHTML = `<p class="text-gray-400 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏™‡∏∏‡πà‡∏°</p>`;
            } else {
                gifts.forEach(num => {
                    const isClaimed = claimed.includes(num);
                    if (isClaimed) {
                        listDiv.innerHTML += `
                            <div class="flex justify-between items-center bg-green-50 p-2 rounded border border-green-200">
                                <span class="font-bold text-green-700">#${num}</span>
                                <span class="text-xs text-green-600 font-bold"><i class="fas fa-check-circle"></i> ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                            </div>`;
                    } else {
                        listDiv.innerHTML += `
                            <div class="flex justify-between items-center bg-white p-2 rounded border border-purple-200 shadow-sm">
                                <span class="font-bold text-purple-700 text-lg">#${num}</span>
                                <button onclick="claimGiftGlobal('${currentScanUserId}', ${num}, '${data.firstname}')" 
                                    class="bg-purple-600 text-white text-xs px-3 py-1.5 rounded hover:bg-purple-700 font-bold shadow">
                                    ‡∏Å‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á
                                </button>
                            </div>`;
                    }
                });
            }
        }

        window.resetScanner = function() {
            if(unsubscribeScanUser) unsubscribeScanUser();
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('readerWrapper').classList.remove('hidden');
            startCamera();
        }

        window.deductQuota = async function(type) {
            if(!currentScanUserId) return;
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ
            const val = parseInt(document.getElementById(type === 'food' ? 'sFood' : type === 'snack' ? 'sSnack' : 'sDrink').innerText);
            if(val <= 0) return alert("‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
            
            try {
                await updateDoc(doc(db, "users", currentScanUserId), { [`quota.${type}`]: increment(-1) });
            } catch(e) { console.error(e); }
        }


        // ================= LOGIC 2: DASHBOARD (‡∏£‡∏ß‡∏°) =================
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç (Realtime)
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ where('giftNumbers', '!=', []) ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á index ‡πÉ‡∏ô Firebase Console
        // ‡∏´‡∏≤‡∏Å error index ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å Link ‡πÉ‡∏ô console log ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ collection ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡πÅ‡∏•‡πâ‡∏ß filter JS ‡πÅ‡∏ó‡∏ô
        const q = collection(db, "users"); 
        
        onSnapshot(q, (snapshot) => {
            const listContainer = document.getElementById('dashboardList');
            const badge = document.getElementById('pendingCountBadge');
            let pendingCount = 0;
            dashboardData = []; // Reset local data

            snapshot.forEach(doc => {
                const d = doc.data();
                const gifts = d.giftNumbers || [];
                const claimed = d.giftsClaimed || [];
                
                // ‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ claim
                const unClaimedGifts = gifts.filter(g => !claimed.includes(g));

                if (unClaimedGifts.length > 0) {
                    pendingCount += unClaimedGifts.length;
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏ó‡∏≥ Search
                    dashboardData.push({
                        id: doc.id,
                        name: d.firstname + " " + d.lastname,
                        org: d.organization,
                        giftNums: unClaimedGifts
                    });
                }
            });

            // Update Badge
            badge.innerText = pendingCount;
            badge.classList.remove('hidden');
            if(pendingCount === 0) badge.classList.add('hidden');

            // Render
            renderDashboard();
        });

        function renderDashboard() {
            const listContainer = document.getElementById('dashboardList');
            const filterText = document.getElementById('searchInput').value.toLowerCase();
            
            listContainer.innerHTML = "";

            // Filter ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            const filtered = dashboardData.filter(item => 
                item.name.toLowerCase().includes(filterText) || 
                item.org.toLowerCase().includes(filterText) ||
                item.giftNums.some(num => num.toString().includes(filterText))
            );

            if (filtered.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-gray-400 mt-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö</div>`;
                return;
            }

            filtered.forEach(user => {
                user.giftNums.forEach(num => {
                    listContainer.innerHTML += `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-pink-100 flex justify-between items-center transform transition hover:scale-[1.02]">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="bg-purple-100 text-purple-700 font-black px-2 py-0.5 rounded text-sm">#${num}</span>
                                    <h3 class="font-bold text-gray-800">${user.name}</h3>
                                </div>
                                <p class="text-xs text-gray-500 mt-1"><i class="fas fa-building"></i> ${user.org}</p>
                            </div>
                            <button onclick="claimGiftGlobal('${user.id}', ${num}, '${user.name}')" 
                                class="bg-gradient-to-r from-pink-500 to-purple-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:opacity-90 active:scale-95">
                                ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á
                            </button>
                        </div>
                    `;
                });
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Search (‡πÅ‡∏Ñ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Render ‡πÉ‡∏´‡∏°‡πà)
        window.filterDashboard = function() {
            renderDashboard();
        }

        // ================= SHARED FUNCTION: CLAIM GIFT =================
        // ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ Scan ‡πÅ‡∏•‡∏∞ Dashboard
        window.claimGiftGlobal = async function(userId, giftNum, userName) {
            // Confirmation Dialog (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ú‡∏¥‡∏î)
            const isConfirmed = confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç?\n\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç: #${giftNum}\n‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: ${userName}`);
            
            if (!isConfirmed) return;

            try {
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, {
                    giftsClaimed: arrayUnion(giftNum)
                });
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á‡∏ï‡∏≤‡∏° Realtime
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            }
        }

    </script>
</body>
</html>
